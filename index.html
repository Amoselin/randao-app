<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>燃道 Rendao | 修煉系統</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <style>
        :root {
            --bg-color: #fcfcfc;
            --ink-color: #2c2c2c;
            --stamp-red: #b22222;
        }

        body {
            margin: 0; background: var(--bg-color); color: var(--ink-color);
            font-family: serif; display: flex; justify-content: center; align-items: center;
            min-height: 100vh; overflow: hidden;
        }

        #app { width: 90%; max-width: 400px; text-align: center; }

        /* --- C概念：視覺動態區 --- */
        .stage-visual {
            position: relative; width: 300px; height: 300px; margin: 0 auto;
            display: flex; justify-content: center; align-items: center;
        }

        /* 呼吸動畫 */
        .breath-ring {
            position: absolute; border: 1px solid var(--ink-color); border-radius: 50%;
            transition: all 2s ease-in-out;
        }

        .is-breathing { animation: breathe 8s infinite ease-in-out; }
        @keyframes breathe {
            0%, 100% { transform: scale(0.8); opacity: 0.3; }
            50% { transform: scale(1.1); opacity: 0.7; }
        }

        /* 墨跡質感效果 (A概念成長變化) */
        .ink-effect {
            filter: blur(4px) contrast(150%);
            opacity: 0.6; transition: opacity 2s;
        }

        /* --- D概念：數位印記彈窗 --- */
        .seal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95); display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 100;
        }

        #sealCanvas { border: 2px solid var(--stamp-red); background: white; max-width: 250px; }

        .btn-action {
            background: none; border: 1px solid var(--ink-color);
            padding: 10px 30px; margin-top: 20px; letter-spacing: 2px;
        }

        .level-tag { font-size: 0.8rem; color: #888; margin-bottom: 20px; }
    </style>
</head>
<body>

<div id="app">
    <div class="level-tag">修煉等級：{{ userLevelName }} (第 {{ sessionCount }} 回)</div>

    <div class="stage-visual">
        <div class="breath-ring" 
             :class="{ 'is-breathing': isPlaying }"
             :style="ringStyle"></div>
        
        <div style="z-index:10">
            <div style="font-size: 0.9rem; letter-spacing: 5px;">{{ currentStageName }}</div>
            <div style="font-size: 3rem; font-weight: 100;">{{ formatTime(timer) }}</div>
        </div>
    </div>

    <p v-if="!timerEnded" style="font-size: 0.9rem; line-height: 2; margin-top: 40px;">
        「仁」：溫柔覺醒<br>觀想內心的慈悲與包容
    </p>

    <button v-if="!timerEnded" class="btn-action" @click="togglePlay">
        {{ isPlaying ? '靜候' : '啟動燃道' }}
    </button>

    <div v-if="showSeal" class="seal-overlay">
        <h3>觀想完成．授印</h3>
        <canvas id="sealCanvas" width="400" height="400"></canvas>
        <p style="font-size: 0.8rem; color: #888;">長按上方印記儲存至相簿</p>
        <button class="btn-action" @click="closeSeal">完成</button>
    </div>

    <audio ref="audioPlayer" src="music-ren.mp3" loop playsinline></audio>
</div>

<script>
    const { createApp, ref, computed, onMounted } = Vue;

    createApp({
        setup() {
            const isPlaying = ref(false);
            const timer = ref(900);
            const sessionCount = ref(Number(localStorage.getItem('rendao_sessions') || 0));
            const timerEnded = ref(false);
            const showSeal = ref(false);
            const audioPlayer = ref(null);
            let interval = null;

            // A概念：等級判定
            const userLevelName = computed(() => {
                if (sessionCount.value < 5) return '初發心';
                if (sessionCount.value < 20) return '行深';
                return '入道';
            });

            // C概念：3-7-5 階段名稱
            const currentStageName = computed(() => {
                if (timer.value > 720) return '調息 (3m)';
                if (timer.value > 300) return '觀想 (7m)';
                return '定境 (5m)';
            });

            // 動態視覺樣式 (隨時間與等級變化)
            const ringStyle = computed(() => {
                let size = 200;
                let border = 1;
                if (timer.value <= 300) size = 100; // 定境時收縮
                if (userLevelName.value === '行深') border = 3;
                if (userLevelName.value === '入道') border = 5;
                
                return {
                    width: size + 'px',
                    height: size + 'px',
                    borderWidth: border + 'px'
                };
            });

            const formatTime = (s) => `${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`;

            const togglePlay = () => {
                if (isPlaying.value) {
                    clearInterval(interval);
                } else {
                    audioPlayer.value.play();
                    interval = setInterval(() => {
                        if (timer.value > 0) {
                            timer.value--;
                        } else {
                            handleFinish();
                        }
                    }, 1000);
                }
                isPlaying.value = !isPlaying.value;
            };

            const handleFinish = () => {
                clearInterval(interval);
                isPlaying.value = false;
                timerEnded.value = true;
                sessionCount.value++;
                localStorage.setItem('rendao_sessions', sessionCount.value);
                generateSeal();
                showSeal.value = true;
            };

            // D概念：數位印記生成器 (Canvas)
            const generateSeal = () => {
                setTimeout(() => {
                    const canvas = document.getElementById('sealCanvas');
                    const ctx = canvas.getContext('2d');
                    const date = new Date().toLocaleDateString();

                    // 繪製背景與框
                    ctx.fillStyle = "white"; ctx.fillRect(0,0,400,400);
                    ctx.strokeStyle = "#b22222"; ctx.lineWidth = 15;
                    ctx.strokeRect(20, 20, 360, 360);

                    // 繪製文字「仁」
                    ctx.fillStyle = "#b22222";
                    ctx.font = "bold 200px serif";
                    ctx.textAlign = "center";
                    ctx.fillText("仁", 200, 240);

                    // 繪製日期與次數 (防偽標記)
                    ctx.font = "24px serif";
                    ctx.fillText(date, 200, 320);
                    ctx.fillText(`第 ${sessionCount.value} 回修煉`, 200, 350);

                    // 加入隨機墨跡 (讓每一枚印章略有不同)
                    for(let i=0; i<30; i++) {
                        ctx.globalAlpha = Math.random() * 0.5;
                        ctx.beginPath();
                        ctx.arc(Math.random()*400, Math.random()*400, Math.random()*5, 0, Math.PI*2);
                        ctx.fill();
                    }
                }, 100);
            };

            const closeSeal = () => {
                showSeal.value = false;
                timer.value = 900;
                timerEnded.value = false;
            };

            return { isPlaying, timer, sessionCount, userLevelName, currentStageName, 
                     ringStyle, formatTime, togglePlay, timerEnded, showSeal, closeSeal, audioPlayer };
        }
    }).mount('#app');
</script>
</body>
</html>