<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>燃道 Rendao | 溫柔覺醒</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@200;400;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <style>
        :root {
            --paper: #ebecf0; /* Soft UI 經典底色 */
            --white: #ffffff;
            --shadow-dark: #babecc;
            --shadow-light: #ffffff;
            --ink: #313131;
            --seal-red: #a62c2b;
            --gray-1: #f2f0eb;
            --gray-2: #e8e5de;
        }

        body, html { margin: 0; padding: 0; height: 100%; background: var(--paper); font-family: "Noto Serif TC", serif; overflow: hidden; }
        #app { height: 100%; display: flex; flex-direction: column; }

        /* --- 頁面一：靜態灰階選擇器 --- */
        .selection-screen { height: 100%; display: flex; flex-direction: column; position: relative; }
        
        .choice-box {
            flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center;
            cursor: pointer; transition: all 0.5s ease;
        }
        .choice-box.top { background-color: var(--gray-1); }
        .choice-box.bottom { background-color: var(--gray-2); }
        
        /* 選擇後的視覺反饋 */
        .choice-box.selected { flex: 1.6; background-color: #e0ddd5; }
        .choice-box.unselected { flex: 0.4; opacity: 0.5; }

        .choice-title { font-size: 1.1rem; letter-spacing: 10px; color: var(--ink); margin-bottom: 8px; }
        .choice-sub { font-size: 0.6rem; letter-spacing: 4px; color: #888; text-transform: uppercase; }

        /* 開始冥想按鈕 (Soft UI 樣式) */
        .start-btn-container {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 50; transition: opacity 0.5s;
        }
        .btn-confirm {
            background: var(--paper); border: none; padding: 18px 50px;
            font-family: "Noto Serif TC"; font-size: 0.9rem; letter-spacing: 8px;
            color: var(--ink); cursor: pointer; border-radius: 50px;
            box-shadow: 6px 6px 12px var(--shadow-dark), -6px -6px 12px var(--shadow-light);
            transition: all 0.2s ease;
        }
        .btn-confirm:active {
            box-shadow: inset 4px 4px 8px var(--shadow-dark), inset -4px -4px 8px var(--shadow-light);
        }

        /* --- 頁面二：計時主畫面 (Soft UI + Liquid) --- */
        .meditation-screen {
            position: fixed; inset: 0; background: var(--paper);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 100;
        }

        /* Pinterest Soft UI 計時器外圈 */
        .timer-container {
            position: relative; width: 300px; height: 300px;
            background: var(--paper); border-radius: 50%;
            box-shadow: 20px 20px 40px var(--shadow-dark), -20px -20px 40px var(--shadow-light);
            display: flex; justify-content: center; align-items: center;
            margin-bottom: 40px;
        }

        /* 液態背景效果 (利用濾鏡實現) */
        .liquid-bg {
            position: absolute; width: 220px; height: 220px;
            filter: blur(20px) contrast(20); /* 關鍵液態濾鏡 */
            z-index: 1; opacity: 0.15;
        }
        .liquid-ball {
            position: absolute; background: var(--ink); border-radius: 50%;
            animation: move-ball 12s infinite ease-in-out alternate;
        }
        @keyframes move-ball {
            0% { transform: translate(-30px, -20px) scale(1); }
            50% { transform: translate(30px, 20px) scale(1.2); }
            100% { transform: translate(-10px, 30px) scale(0.9); }
        }

        .timer-display { font-size: 3.5rem; font-weight: 200; letter-spacing: -2px; z-index: 10; color: var(--ink); }

        /* 結束冥想按鈕 */
        .btn-end {
            background: var(--paper); border: none; padding: 12px 35px;
            border-radius: 30px; font-size: 0.75rem; letter-spacing: 5px; color: #888;
            box-shadow: 4px 4px 8px var(--shadow-dark), -4px -4px 8px var(--shadow-light);
            cursor: pointer; transition: 0.3s;
        }
        .btn-end:active { box-shadow: inset 2px 2px 5px var(--shadow-dark); }

        /* --- 數位印記 --- */
        .modal { position: fixed; inset: 0; background: var(--paper); z-index: 200; display: flex; flex-direction: column; justify-content: center; align-items: center; }

        .fade-enter-active, .fade-leave-active { transition: opacity 1s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
    </style>
</head>
<body>

<div id="app">
    <div v-if="view === 'selection'" class="selection-screen">
        <div class="choice-box top" :class="{ selected: mode === 'voice', unselected: mode === 'pure' }" @click="mode = 'voice'">
            <div class="choice-title">導引冥想</div>
            <div class="choice-sub">Guided</div>
        </div>
        <div class="choice-box bottom" :class="{ selected: mode === 'pure', unselected: mode === 'voice' }" @click="mode = 'pure'">
            <div class="choice-title">純境音樂</div>
            <div class="choice-sub">Pure</div>
        </div>
        <div v-if="mode" class="start-btn-container">
            <button class="btn-confirm" @click="start">開始冥想</button>
        </div>
    </div>

    <transition name="fade">
        <div v-if="view === 'active'" class="meditation-screen">
            <div style="position: absolute; top: 40px; font-size: 0.65rem; color: #aaa; letter-spacing: 3px;">
                {{ levelName }}．第 {{ sessions }} 回修行
            </div>

            <div class="timer-container">
                <div class="liquid-bg">
                    <div class="liquid-ball" style="width: 100px; height: 100px; left: 50px; top: 50px;"></div>
                    <div class="liquid-ball" style="width: 80px; height: 80px; left: 80px; top: 80px; animation-delay: -3s;"></div>
                    <div class="liquid-ball" style="width: 120px; height: 120px; left: 40px; top: 70px; animation-delay: -6s;"></div>
                </div>
                <div class="timer-display">{{ formatTime(timer) }}</div>
            </div>

            <div style="margin-bottom: 40px; font-size: 1.1rem; letter-spacing: 12px; font-weight: 300;">溫柔覺醒</div>
            
            <button class="btn-end" @click="confirmEnd">結束冥想</button>
        </div>
    </transition>

    <div v-if="showSeal" class="modal">
        <canvas id="sealCanvas" width="300" height="300"></canvas>
        <button class="btn-confirm" style="margin-top: 40px;" @click="reset">重回本心</button>
    </div>

    <audio ref="audioPlayer" :src="audioUrl" loop playsinline></audio>
</div>

<script>
    const { createApp, ref, computed } = Vue;
    createApp({
        setup() {
            const view = ref('selection');
            const mode = ref(null);
            const timer = ref(900);
            const sessions = ref(Number(localStorage.getItem('rd_count') || 0));
            const showSeal = ref(false);
            const audioPlayer = ref(null);
            let wakeLock = null;
            let interval = null;

            const audioUrl = computed(() => 'https://slbktbschxdrliypfmos.supabase.co/storage/v1/object/public/meditation-assets/music-ren-pure.mp3');
            const levelName = computed(() => sessions.value < 7 ? '初發心' : (sessions.value < 21 ? '行深位' : '入道位'));

            const start = async () => {
                view.value = 'active';
                setTimeout(() => {
                    audioPlayer.value.play();
                    if ('wakeLock' in navigator) navigator.wakeLock.request('screen').then(l => wakeLock = l);
                    interval = setInterval(() => { if (timer.value > 0) timer.value--; else finish(); }, 1000);
                }, 500);
            };

            const finish = () => {
                clearInterval(interval);
                sessions.value++;
                localStorage.setItem('rd_count', sessions.value);
                showSeal.value = true;
                setTimeout(drawSeal, 100);
            };

            const drawSeal = () => {
                const canvas = document.getElementById('sealCanvas');
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = "white"; ctx.fillRect(0,0,300,300);
                ctx.strokeStyle = "#a62c2b"; ctx.lineWidth = 6;
                ctx.strokeRect(45, 45, 210, 210);
                ctx.fillStyle = "#a62c2b"; ctx.textAlign = "center";
                ctx.font = "bold 28px 'Noto Serif TC'";
                ctx.fillText("溫柔覺醒", 150, 140);
                ctx.font = "14px 'Noto Serif TC'";
                ctx.fillText(`第 ${sessions.value} 回紀錄`, 150, 185);
                ctx.globalCompositeOperation = 'destination-out';
                for(let i=0; i<150; i++) { ctx.beginPath(); ctx.arc(Math.random()*300, Math.random()*300, Math.random()*1.2, 0, Math.PI*2); ctx.fill(); }
            };

            const reset = () => {
                clearInterval(interval);
                if (wakeLock) wakeLock.release();
                view.value = 'selection';
                mode.value = null;
                showSeal.value = false;
                timer.value = 900;
                audioPlayer.value.pause();
                audioPlayer.value.currentTime = 0;
            };

            const formatTime = (s) => `${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`;
            const confirmEnd = () => { if(confirm("確定要結束這次冥想嗎？")) reset(); };

            return { view, mode, timer, sessions, levelName, audioUrl, showSeal, start, formatTime, confirmEnd, reset, audioPlayer };
        }
    }).mount('#app');
</script>
</body>
</html>
