<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>燃道 Rendao | 仁</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@200;400;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <style>
        :root {
            --paper: #f9f7f2;
            --ink: #1a1a1a;
            --seal-red: #a62c2b;
            --transition: 1.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            margin: 0; background-color: var(--paper); color: var(--ink);
            font-family: "Noto Serif TC", serif; overflow: hidden;
            display: flex; justify-content: center; align-items: center; min-height: 100vh;
            -webkit-user-select: none; /* 防止誤觸選取文字 */
        }

        #app { width: 100%; max-width: 400px; text-align: center; padding-bottom: 50px; }

        /* --- 狀態提示 --- */
        .status-bar {
            position: fixed; top: 30px; left: 0; width: 100%; 
            display: flex; justify-content: space-between; padding: 0 30px; box-sizing: border-box;
            font-size: 0.65rem; letter-spacing: 2px; color: #bbb;
        }
        .active-red { color: var(--seal-red); }

        /* --- 視覺核心 (C概念) --- */
        .zen-stage {
            position: relative; width: 300px; height: 300px; margin: 0 auto 40px;
            display: flex; justify-content: center; align-items: center;
        }
        .ring {
            position: absolute; inset: 0; border: 0.5px solid var(--ink);
            border-radius: 50%; opacity: 0.15; transition: var(--transition);
        }
        .ring.breathing { animation: zen-breathe 8s infinite ease-in-out; opacity: 0.5; }
        
        @keyframes zen-breathe {
            0%, 100% { transform: scale(0.88); opacity: 0.3; }
            50% { transform: scale(1.05); opacity: 0.6; }
        }

        .timer-display { font-size: 3.5rem; font-weight: 200; letter-spacing: -2px; z-index: 10; }

        /* --- 模式選擇器 --- */
        .selector {
            display: flex; justify-content: center; gap: 30px; margin-bottom: 40px;
            transition: opacity 0.8s;
        }
        .opt {
            font-size: 0.8rem; letter-spacing: 4px; color: #ccc; cursor: pointer;
            padding-bottom: 4px; border-bottom: 1px solid transparent; transition: 0.4s;
        }
        .opt.active { color: var(--ink); border-bottom: 1px solid var(--ink); }

        /* --- 啟動按鈕 --- */
        .btn-main {
            background: none; border: 0.5px solid var(--ink); padding: 12px 40px;
            font-size: 0.9rem; letter-spacing: 8px; cursor: pointer;
            transition: all 0.5s; position: relative;
        }
        .btn-main:hover { background: var(--ink); color: white; }

        /* --- 數位印記 Modal (D概念) --- */
        .modal {
            position: fixed; inset: 0; background: var(--paper); z-index: 100;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        #sealCanvas { box-shadow: 0 10px 40px rgba(0,0,0,0.05); cursor: pointer; }

        .hidden { opacity: 0; pointer-events: none; }
    </style>
</head>
<body>

<div id="app">
    <div class="status-bar">
        <div>{{ levelName }}．第 {{ sessions }} 回</div>
        <div :class="{ 'active-red': isWakeLockActive }">
            {{ isWakeLockActive ? '● 長明中' : '○ 待命' }}
        </div>
    </div>

    <div class="zen-stage">
        <div class="ring" :class="{ breathing: isPlaying }" :style="ringStyle"></div>
        <div class="timer-display">{{ formatTime(timer) }}</div>
    </div>

    <div :class="{ hidden: isPlaying && timer < 895 }">
        <div class="selector">
            <div class="opt" :class="{ active: mode === 'voice' }" @click="mode = 'voice'">導引</div>
            <div class="opt" :class="{ active: mode === 'pure' }" @click="mode = 'pure'">純境</div>
        </div>

        <h2 style="font-weight: 300; letter-spacing: 12px; margin-bottom: 40px;">仁</h2>
        
        <button class="btn-main" @click="togglePlay">
            {{ isPlaying ? '靜候' : '啟動燃道' }}
        </button>
    </div>

    <div v-if="showSeal" class="modal">
        <div style="letter-spacing: 10px; font-size: 0.8rem; margin-bottom: 40px; color: #888;">觀想圓滿</div>
        <canvas id="sealCanvas" width="300" height="300"></canvas>
        <p style="margin-top: 30px; font-size: 0.7rem; color: #bbb; letter-spacing: 2px;">長按印記．典藏修行</p>
        <button class="btn-main" style="margin-top: 30px;" @click="closeSeal">重回本心</button>
    </div>

    <audio ref="audioPlayer" :src="currentAudioUrl" loop playsinline></audio>
</div>

<script>
    const { createApp, ref, computed, watch, onMounted } = Vue;

    createApp({
        setup() {
            const isPlaying = ref(false);
            const timer = ref(900); // 15分鐘
            const mode = ref(localStorage.getItem('rd_mode') || 'pure');
            const sessions = ref(Number(localStorage.getItem('rd_count') || 0));
            const showSeal = ref(false);
            const isWakeLockActive = ref(false);
            const audioPlayer = ref(null);
            let wakeLock = null;
            let interval = null;

            // --- 音訊網址設定 ---
            const currentAudioUrl = computed(() => {
                // 如果之後有導引版，請將網址貼在下方引號內
                const voiceUrl = 'https://slbktbschxdrliypfmos.supabase.co/storage/v1/object/public/meditation-assets/music-ren-pure.mp3'; 
                const pureUrl = 'https://slbktbschxdrliypfmos.supabase.co/storage/v1/object/public/meditation-assets/music-ren-pure.mp3';
                return mode.value === 'voice' ? voiceUrl : pureUrl;
            });

            const levelName = computed(() => {
                if (sessions.value < 7) return '初發心';
                if (sessions.value < 21) return '行深位';
                return '入道位';
            });

            // 圓環隨階段縮放
            const ringStyle = computed(() => {
                let size = 280;
                if (timer.value <= 300) size = 180; // 最後5分鐘縮小
                return { width: size + 'px', height: size + 'px' };
            });

            watch(mode, (val) => localStorage.setItem('rd_mode', val));

            const formatTime = (s) => `${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`;

            // --- 螢幕恆亮控制 ---
            const requestWakeLock = async () => {
                if ('wakeLock' in navigator) {
                    try {
                        wakeLock = await navigator.wakeLock.request('screen');
                        isWakeLockActive.value = true;
                        wakeLock.addEventListener('release', () => isWakeLockActive.value = false);
                    } catch (e) { console.error("WakeLock failed"); }
                }
            };

            const togglePlay = async () => {
                if (isPlaying.value) {
                    clearInterval(interval);
                    audioPlayer.value.pause();
                    if (wakeLock) await wakeLock.release();
                } else {
                    audioPlayer.value.play();
                    await requestWakeLock();
                    interval = setInterval(() => {
                        if (timer.value > 0) timer.value--;
                        else handleFinish();
                    }, 1000);
                }
                isPlaying.value = !isPlaying.value;
            };

            const handleFinish = () => {
                clearInterval(interval);
                isPlaying.value = false;
                sessions.value++;
                localStorage.setItem('rd_count', sessions.value);
                showSeal.value = true;
                setTimeout(drawSeal, 100);
            };

            const drawSeal = () => {
                const canvas = document.getElementById('sealCanvas');
                const ctx = canvas.getContext('2d');
                const date = new Date().toLocaleDateString();
                
                // 背景
                ctx.fillStyle = "white"; ctx.fillRect(0,0,300,300);
                // 邊框
                ctx.strokeStyle = "#a62c2b"; ctx.lineWidth = 8;
                ctx.strokeRect(35, 35, 230, 230);
                // 文字
                ctx.fillStyle = "#a62c2b";
                ctx.font = "bold 120px 'Noto Serif TC'";
                ctx.textAlign = "center";
                ctx.fillText("仁", 150, 180);
                // 細項
                ctx.font = "14px 'Noto Serif TC'";
                ctx.fillText(`燃道．第 ${sessions.value} 回`, 150, 230);
                ctx.font = "10px serif";
                ctx.fillText(date, 150, 250);

                // 隨機殘損效果 (D概念精髓)
                ctx.globalCompositeOperation = 'destination-out';
                for(let i=0; i<300; i++){
                    ctx.beginPath();
                    ctx.arc(Math.random()*300, Math.random()*300, Math.random()*1.2, 0, Math.PI*2);
                    ctx.fill();
                }
            };

            const closeSeal = () => {
                showSeal.value = false;
                timer.value = 900;
            };

            return { isPlaying, timer, mode, sessions, levelName, isWakeLockActive, currentAudioUrl, ringStyle, formatTime, togglePlay, showSeal, closeSeal, audioPlayer };
        }
    }).mount('#app');
</script>
</body>
</html>
